{% extends 'layout.html.twig' %}

{% block content %}

    <div class="row">
        <div class="col-md-12">

            <h2 class="titre_rubrique">Votre parcours</h2>

            <form role="form" action="index.php?uc=formulaire&action=traiterChoixFormation"
                  id="formChoixFormation" method="post">
                <input type="hidden" id="typeDossier" name="typeDossier"  />

                <fieldset>
                    <legend>Formation souhaitée</legend>
                    <div class="well well-fg">
                        <div id="textboxIne" class="form-group has-success">
                            <label for="ine">Votre numéro INE </label> <span class="en">INE number</span>
                            <input class="form-control" type="text" id="ine" name="ine" placeholder="123456789A"
                                   data-validation="required"
                                   data-validation-error-msg="Veuillez entrer un numéro d'INE valide" />
                        </div>
                        <div class="form-group">
                            <label for="derniere">Sélectionnez votre dernière formation effectuée</label>
                            <span class="en">Training followed</span>
                            <span class="label label-danger">Requis</span>
                            <select class="form-control" id="derniere" name="derniere">
                                <option value="">&mdash; Sélectionnez &mdash;</option>
                                {% for formation in formations %}
                                    <optgroup label="{{ formation.mention }}">
                                    {% for voeu in voeux %}
                                        {% if voeu.codeFormation == formation.codeFormation %}
                                            <option value="{{ voeu.codeEtape }}">{{ voeu.etape }}</option>
                                        {% endif %}
                                    {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- /form-group -->
                        <div id="autre_formation">
                            <div class="form-group">
                                <label for="nomAutreFormation">Veuillez entrer le nom de la dernière
                                    formation que vous avez effectuée</label>
                                <span class="label label-danger">Requis</span>
                                <input type="text" class="form-control" id="nomAutreFormation"
                                       name="nomAutreFormation">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="choisie">Sélectionnez la formation souhaitée pour l'année scolaire
                                2014-2015</label>
                            <span class="en">Whish training</span>
                            <span class="label label-danger">Requis</span>
                            <select class="form-control" id="choisie" name="choisie">
                                <option value="">&mdash; Sélectionnez &mdash;</option>
                                {% for formation in formations %}
                                    <option value="{{ formation.codeformation }}">{{ formation.mention }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="displayDocuments"></div>
                        <div id="divAllDocuments" class="form-group">
                            <label>Etez-vous en possession de tous les documents demandés ?</label>

                            <div class="radio">
                                <label for="oui">
                                    <input type="radio" id="oui" name="allDocuments" value="oui"/> Oui
                                </label>
                            </div>
                            <div class="radio">
                                <label for="non">
                                    <input type="radio" id="non" name="allDocuments" value="non" checked/> Non
                                </label>
                            </div>
                        </div>
                        <input type="submit" class="btn btn-primary"/>
                        <br/><br/>

                        <div id="msgErrorIne"></div>
                    </div>
                </fieldset>
            </form>

        </div>
    </div>

{% endblock %}

{% block scripts %}
    {{ parent() }}
    <script src="./public/js/jquery-form-validator/jquery.form-validator.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('input[type=submit]').hide();
            $('#divAllDocuments').hide();
            $('#msgError').hide();

            var checkCreationDossierPossible = function () {
                var ine = $('#ine').val();
                var codeFormation = $('#choisie').val();
                $.ajax({
                    url: 'index.php?uc=formulaire&action=candidaturePossible',
                    type: 'post',
                    data: 'ine=' + ine + '&code_formation=' + codeFormation,
                    dataType: 'json',
                    success: function (json) {
                        if (json.response == 0) {
                            if ($('#textboxIne').hasClass('has-success')) {
                                $('#textboxIne').removeClass('has-success').addClass('has-error');
                            }
                        } else {
                            if ($('#textboxIne').hasClass('has-error')) {
                                $('#textboxIne').removeClass('has-error').addClass('has-success');
                            }
                        }
                    }
                });
            };

            var getTypeDossier = function() {
                var codeEtape = $('#derniere').val();
                var codeFormation = $('#choisie').val();

                $.ajax({
                    url: 'index.php?uc=formulaire&action=typeDossier',
                    type: 'post',
                    data: 'code_etape=' + codeEtape + '&code_formation=' + codeFormation,
                    dataType: 'json',
                    success: function (json) {
                        $('#typeDossier').val(json.type);
                    }
                });
            };

            //var choixFormation = $("select[name='derniere'] > option:selected").val();
            var choixFormation = $('#derniere').val();
            var autreFormation = $("#autre_formation");

            (choixFormation === "Autre") ? autreFormation.fadeIn("slow") : autreFormation.hide();

            $('#derniere').on('change', function () {
                choixFormation = $(this).val();
                (choixFormation === "0000") ? autreFormation.fadeIn("slow") : autreFormation.fadeOut("fast");
                getTypeDossier();
            });

            $('input[type=radio]').on('change', function () {
                if ($(this).val() == 'oui') {
                    $('input[type=submit]').show();
                } else {
                    $('input[type=submit]').hide();
                }
            });

            $('#ine').on('input', function () {
                checkCreationDossierPossible();
            });
            $('#choisie').on('change', function () {
                $('#divAllDocuments').show();
                checkCreationDossierPossible();
                getTypeDossier();
                $.ajax({
                    url: 'index.php?uc=formulaire&action=displayDocuments',
                    type: 'post',
                    data: 'code=' + $('#choisie').val(),
                    dataType: 'json',
                    success: function (json) {
                        $('#displayDocuments').empty();
                        if (!$('#displayDocuments').hasClass('alert') && !$('#displayDocuments').hasClass('alert-warning')) {
                            $('#displayDocuments').addClass('alert');
                            $('#displayDocuments').addClass('alert-warning');
                        }

                        var documentsGeneraux = json.general;
                        var documentsSpecifiques = json.specifique;
                        var listeDocumentsGeneraux = $('<ul></ul>');
                        var listeDocumentsSpecifiques = $('<ul></ul>');

                        documentsGeneraux.forEach(function (doc) {
                            var li = $('<li></li>').append(doc)
                            listeDocumentsGeneraux.append(li);
                        });
                        documentsSpecifiques.forEach(function (doc) {
                            console.log(doc)
                            var li = $('<li></li>').append(doc[0]);
                            if (doc[1] !== "") {
                                var link = $('<a></a>')
                                        .attr('href', doc[1]).
                                        append('Cliquez ici pour télécharger le document');
                                li.append(' - ')
                                        .append(link);
                            }
                            listeDocumentsSpecifiques.append(li);
                        });
                        var alert = $('<div></div>')
                                .addClass('alert')
                                .addClass('alert-danger')
                                .append(
                                        $('<button></button>')
                                                .addClass('close')
                                                .attr('data-dismiss', 'alert')
                                                .attr('aria-hidden', 'true')
                                                .append('&times;')
                                ).append('Pour postuler à cette formation, assurez vous d\'être en possession des documents ci dessous :');

                        $('#displayDocuments').before().append(alert);

                        $('#displayDocuments').append('<h4>Documents communs</h4>')
                                .append(listeDocumentsGeneraux);
                        if (documentsSpecifiques.length > 0) {
                            $('#displayDocuments').append('<br/><h4>Documents spécifiques à la formation choisie</h4>')
                                    .append(listeDocumentsSpecifiques);
                        }
                    }
                });
            });


            // Vérification formulaire
            $.validate({
                onError: function () {
                    $('#msgErrorIne')
                            .attr('class', 'alert alert-danger alert-dismissable')
                            .append(
                                    $('<button/>')
                                            .attr('class', 'close')
                                            .attr('data-dismiss', 'alert')
                                            .attr('aria-hidden', 'true')
                                            .html('&times;'))
                            .append('<strong>Attention!</strong> Veuillez indiquer votre numéro INE.')
                            .show('fast');
                }
            });
        });
    </script>
{% endblock %}

